<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SBP Scanner</title>
    <!-- Сканер QR -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Блокчейн библиотеки -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    
    <style>
        body { 
            background-color: #000; color: #fff; 
            font-family: -apple-system, sans-serif; 
            margin: 0; padding: 20px; text-align: center;
            --w3m-z-index: 100000 !important;
        }

        h2 { color: #FFD700; margin-bottom: 5px; }
        p { color: #777; font-size: 13px; }

        /* ОКНО КАМЕРЫ */
        #reader {
            width: 100%; margin: 20px auto; 
            border: 2px solid #333; border-radius: 20px; 
            overflow: hidden;
        }

        /* КНОПКИ */
        .btn {
            width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; font-size: 16px; margin-top: 10px;
        }
        .btn-gold { background: linear-gradient(135deg, #FFD700, #DAA520); color: black; }
        .btn-grey { background: #333; color: white; }

        /* ИНПУТ СУММЫ */
        input {
            width: 100%; padding: 15px; border-radius: 12px;
            background: #111; border: 1px solid #444; color: white;
            font-size: 24px; text-align: center; box-sizing: border-box;
        }

        /* ЭКРАНЫ */
        .screen { display: none; }
        .active { display: block; }
        
        #result-box { margin-top: 20px; background: #111; padding: 20px; border-radius: 15px; border: 1px solid #333; }
    </style>

    <!-- AppKit (Кошелек) -->
    <script type="module">
        import { createWeb3Modal, defaultConfig } from 'https://esm.sh/@web3modal/ethers@5.0.0'
        const projectId = '7b83e930c9c584b3d751e271babdb18d' // Ваш ID
        const polygon = { chainId: 137, name: 'Polygon', currency: 'POL', explorerUrl: 'https://polygonscan.com', rpcUrl: 'https://polygon-rpc.com' }
        const metadata = { name: 'SBP Pay', description: 'Scanner', url: 'https://qendl.github.io', icons: [] }
        
        const modal = createWeb3Modal({
            ethersConfig: defaultConfig({ metadata }), chains: [polygon], projectId,
            enableAnalytics: false, enableEmail: false, allWallets: 'SHOW', themeMode: 'dark',
            themeVariables: { '--w3m-accent': '#FFD700', '--w3m-z-index': '100000' }
        })
        window.modal = modal;
    </script>
</head>
<body>

    <!-- 1. ЭКРАН СТАРТА -->
    <div id="screen-start" class="screen active">
        <h2>SCAN CHEQUE</h2>
        <p>Payment via Galactic Credit</p>
        <div id="reader"></div>
        <p style="font-size:11px; margin-top:10px;">Point camera at SBP QR code</p>
    </div>

    <!-- 2. ЭКРАН СУММЫ (Появляется после скана) -->
    <div id="screen-pay" class="screen">
        <h2>AMOUNT (RUB)</h2>
        <input type="number" id="rubAmount" placeholder="0" oninput="calcCred()">
        
        <div id="result-box">
            <p>Exchange Rate: ~100 RUB/$</p>
            <h3 id="credTotal" style="color: #FFD700; font-size: 28px;">0 CRED</h3>
        </div>

        <button onclick="pay()" class="btn btn-gold" id="payBtn">Connect & Pay</button>
        <button onclick="location.reload()" class="btn btn-grey">Cancel</button>
    </div>

    <script>
        const TOKEN_ADDR = '0x5F9016b380782bd98D2C7893e5b2E39e95Dd1378';
        const ADMIN_WALLET = '0x292784D32dC5E8D93F19a40D216BbBb17F81387c'; // Сюда придут CRED
        let scanner;

        // Запуск сканера при загрузке
        function startScanner() {
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (text) => {
                // Если QR найден
                if (text.includes("http") || text.includes("sbp")) {
                    scanner.stop();
                    document.getElementById('screen-start').classList.remove('active');
                    document.getElementById('screen-pay').classList.add('active');
                    // Тут мы бы могли вытащить данные из QR, но пока спрашиваем сумму
                }
            }).catch(err => {
                alert("Camera Error: " + err);
            });
        }
        
        // Даем секунду на прогрузку библиотек и стартуем
        setTimeout(startScanner, 1000);

        // Калькулятор
        function calcCred() {
            const rub = document.getElementById('rubAmount').value;
            // Условный курс (Для демо): 1 CRED = 300 RUB 
            // В будущем тут нужен API запрос к курсу
            const cred = (rub / 300).toFixed(2); 
            document.getElementById('credTotal').innerText = cred + " CRED";
        }

        // Оплата
        async function pay() {
            // 1. Проверяем кошелек
            if (!window.modal.getIsConnected()) {
                await window.modal.open();
                document.getElementById('payBtn').innerText = "Confirm Transaction...";
                return; 
            }

            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const contract = new ethers.Contract(TOKEN_ADDR, [
                    "function transfer(address to, uint256 amount) external returns (bool)"
                ], signer);

                const rub = document.getElementById('rubAmount').value;
                if(!rub) return alert("Enter Amount!");
                
                const credAmount = (rub / 300).toFixed(18); // Курс демо
                const wei = ethers.parseUnits(credAmount, 18);

                alert("Please confirm transaction in Wallet");
                
                const tx = await contract.transfer(ADMIN_WALLET, wei);
                await tx.wait();
                
                alert("✅ Payment Successful! \n(Admin received CRED)");
                location.reload();

            } catch(e) {
                console.log(e);
                alert("Payment Failed");
            }
        }
    </script>
</body>
</html>
